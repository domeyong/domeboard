<script>
  const topics = ["UXLINK", "MIRA", "NEWTON", "MONAD", "HANAHANA", "THEORIQ", "OPENLEDGER", "SYMPHONY", "MNT", "HUMANITY", "KAITO" ,"BOOPBOOPFUN"];

  async function fetchMindshare(kolId, topic, duration) {
    const url = "https://hub.kaito.ai/api/v1/gateway/ai";
    const headers = { "Content-Type": "application/json" };
    const body = JSON.stringify({
      path: "/api/yapper/public_kol_mindshare",
      method: "GET",
      params: {
        kol: kolId,
        type: "kol",
        duration: duration,
        customized_community: "customized",
        community_yaps: true,
        topic_id: topic
      },
      body: {}
    });

    try {
      const response = await fetch(url, {
        method: "POST",
        headers,
        body
      });

      if (!response.ok) return { error: `API 오류: ${response.status}` };

      const data = await response.json();
      const result = data.resultWithKol?.[0];
      if (!result) return { error: `${topic} 데이터 없음` };

      return {
        mindshare: result[`last_${duration}_mindshare`] ?? null,
        rank: result.rank ?? null
      };
    } catch (e) {
      return { error: e.message };
    }
  }

  async function fetchProfile(kolId) {
    const url = "https://hub.kaito.ai/api/v1/gateway/ai";
    const headers = { "Content-Type": "application/json" };
    const body = JSON.stringify({
      path: "/api/yapper/public_kol_profile",
      method: "GET",
      params: {
        kol: kolId
      },
      body: {}
    });

    try {
      const res = await fetch(url, {
        method: "POST",
        headers,
        body
      });
      const json = await res.json();
      const info = json.result;
      if (!info) return null;

      return {
        icon: info.icon,
        name: info.name,
        username: info.username,
        followers: info.follower_count
      };
    } catch {
      return null;
    }
  }

  async function searchMindshare() {
    const kolId = document.getElementById("kolIdInput").value.trim();
    const resultDiv = document.getElementById("result");
    const button = document.getElementById("searchBtn");
    const originalText = button.innerText;

    if (!kolId) {
      resultDiv.innerHTML = '<p class="error-msg">콜ID를 입력해주세요.</p>';
      return;
    }

    button.innerText = "조회 중...";
    button.disabled = true;
    resultDiv.innerHTML = "";

    let html = "";

    // 🔹 프로필 박스 먼저 출력
    const profile = await fetchProfile(kolId);
    if (profile) {
      html += `
        <div class="profile">
          <img src="${profile.icon}" />
          <div class="profile-info">
            <p><strong>@${profile.username}</strong> (${profile.name})</p>
            <p>팔로워: ${profile.followers.toLocaleString()}명</p>
          </div>
        </div>`;
    }

    for (const topic of topics) {
      const res7 = await fetchMindshare(kolId, topic, "7d");
      const res30 = await fetchMindshare(kolId, topic, "30d");

      if (res7.error || res30.error) {
        html += `<div class="topic-result"><h3>${topic} 프로젝트</h3><p class="error-msg">${res7.error || res30.error}</p></div>`;
      } else {
        const m7 = res7.mindshare?.toFixed(8) ?? "N/A";
        const r7 = res7.rank ?? "N/A";
        const m30 = res30.mindshare?.toFixed(8) ?? "N/A";
        const r30 = res30.rank ?? "N/A";

        html += `
          <div class="topic-result">
            <h3>${topic} 프로젝트</h3>
            <p>최근 7일 마인드쉐어: ${m7} (랭킹: ${r7})</p>
            <p>최근 30일 마인드쉐어: ${m30} (랭킹: ${r30})</p>
          </div>`;
      }
    }

    resultDiv.innerHTML = html;
    button.innerText = originalText;
    button.disabled = false;
  }
</script>

